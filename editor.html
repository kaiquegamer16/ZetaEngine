<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zeta Engine - Live Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap');

        * { box-sizing: border-box; user-select: none; outline: none; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #050505; color: #ddd;
            font-family: 'Roboto', sans-serif; overflow: hidden;
            display: flex; flex-direction: column;
        }

        #toolbar {
            height: 50px; background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 10;
        }
        .toolbar-group { display: flex; gap: 10px; align-items: center; }
        .tool-btn {
            background: transparent; border: 1px solid #333; border-radius: 4px;
            width: 40px; height: 35px; cursor: pointer; color: #888;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; font-size: 1.2rem;
        }
        .tool-btn:hover { background: rgba(0, 243, 255, 0.1); color: #00f3ff; border-color: #00f3ff; }
        .save-btn { font-size: 0.8rem; width: auto; padding: 0 15px; gap: 5px; font-family: 'Orbitron'; }

        #workspace { flex: 1; display: flex; position: relative; overflow: hidden; }
        #viewport { flex: 1; background-color: #1a1a1a; position: relative; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        #code-editor-container {
            flex: 1; display: none; flex-direction: column;
            background: #141414; position: relative; z-index: 30;
        }
        #ace-editor { flex: 1; font-size: 14px; }
        .editor-bar {
            height: 35px; background: #1a1a1a; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 10px;
        }

        #sidebar {
            width: 260px; background: #0f0f12; border-left: 1px solid #333;
            display: flex; flex-direction: column; z-index: 20;
        }
        .panel-header {
            padding: 12px; background: #151518; border-bottom: 1px solid #00f3ff;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: #00f3ff;
            display: flex; align-items: center; gap: 8px;
        }
        .panel-content { padding: 10px; flex: 1; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 0.85rem;}

        .tree-node { margin-left: 10px; }
        .tree-item {
            display: flex; align-items: center; padding: 4px 0;
            cursor: pointer; color: #aaa; transition: 0.2s;
        }
        .tree-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .arrow {
            display: inline-block; width: 20px; text-align: center; font-size: 10px;
            cursor: pointer; transition: transform 0.2s; color: #666;
        }
        .arrow.open { transform: rotate(90deg); color: #00f3ff; }
        .arrow.hidden { visibility: hidden; }
        .icon { margin-right: 6px; }
        .folder-icon { color: #dcb67a; } .js-icon { color: #f7df1e; }
        .tree-children { display: none; border-left: 1px solid #333; margin-left: 9px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .asset-modal {
            background: #111; border: 1px solid #00f3ff; width: 300px;
            padding: 20px; border-radius: 8px; box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
        }
        .modal-option {
            background: #1a1a1a; color: #ddd; padding: 12px; margin-bottom: 8px;
            border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .modal-option:hover { border-color: #00f3ff; background: #222; color: #fff; }
        .delete-opt:hover { border-color: #ff0055; color: #ff0055; }
        .modal-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; margin-bottom: 10px; }
        .btn-action { background: #00f3ff; color: #000; border: none; padding: 6px 12px; cursor: pointer; font-weight: bold; }

        #console-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0, 0, 0, 0.95); border-top: 1px solid #00f3ff;
            transform: translateY(100%); transition: transform 0.3s ease;
            z-index: 5; display: flex; flex-direction: column;
        }
        #console-panel.open { transform: translateY(0); }
        .console-body { padding: 10px; font-family: 'Fira Code', monospace; font-size: 0.8rem; color: #aaa; overflow-y: auto; flex: 1; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.171.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.171.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>

    <div id="toolbar">
        <div class="toolbar-group">
            <button class="tool-btn" onclick="window.location.href='menu.html'">‚¨Ö</button>
            <button class="tool-btn save-btn" onclick="saveProject()">üíæ SALVAR</button>
        </div>
        <div class="toolbar-group">
            <button id="btn-play" class="tool-btn btn-play" onclick="startPlay()">‚ñ∂</button>
            <button id="btn-stop" class="tool-btn btn-stop" style="display:none;" onclick="stopPlay()">‚èπ</button>
        </div>
        <div class="toolbar-group">
            <button class="tool-btn" onclick="toggleConsole()">üíª</button>
        </div>
    </div>

    <div id="workspace">
        <div id="viewport">
            <div id="console-panel">
                <div style="padding:5px 10px; background:#111; color:#00f3ff; display:flex; justify-content:space-between;">
                    <span>LOG</span><span style="cursor:pointer" onclick="toggleConsole()">‚ñº</span>
                </div>
                <div class="console-body" id="console-log"></div>
            </div>
        </div>

        <div id="code-editor-container">
            <div class="editor-bar">
                <div style="color:#f7df1e; font-family:'Fira Code'">üìú <span id="current-file-name">script.js</span></div>
                <button class="btn-action" onclick="closeScriptEditor()">SALVAR & FECHAR</button>
            </div>
            <div id="ace-editor"></div>
        </div>

        <div id="sidebar">
            <div class="panel-header">üìÇ PROJECT ASSETS</div>
            <div class="panel-content" id="asset-tree"></div>
        </div>
    </div>

    <div id="modal-options" class="modal-overlay">
        <div class="asset-modal">
            <h3 id="modal-title">Op√ß√µes</h3>
            <div id="ctx-folder">
                <div class="modal-option" onclick="showInput('folder')">üìÅ Nova Pasta</div>
                <div class="modal-option" onclick="showInput('script')">üìú Novo Script JS</div>
            </div>
            <div id="ctx-script" style="display:none;">
                <div class="modal-option" onclick="openScriptEditor()">‚úèÔ∏è Editar C√≥digo</div>
                <div class="modal-option" onclick="applyScriptToScene()">‚ö° Aplicar na Cena (Global)</div>
            </div>
            <div class="modal-option delete-opt" onclick="deleteItem()">üóëÔ∏è Deletar</div>
            
            <div id="input-area" style="display:none;">
                <input type="text" id="new-item-name" class="modal-input" placeholder="Nome...">
                <div style="display:flex; justify-content:end; gap:10px;">
                    <button class="btn-action" style="background:#333; color:#fff" onclick="resetModal()">Cancelar</button>
                    <button class="btn-action" onclick="confirmCreation()">CRIAR</button>
                </div>
            </div>
            <div style="display:flex; justify-content:end; margin-top:15px;" id="default-actions">
                <button class="btn-action" style="background:#333; color:#fff" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- GLOBAIS ---
        let scene, camera, renderer, controls, clock;
        let selectedObject3D = null;
        let isPlaying = false;
        let activeScripts = []; // { scope: {}, func: Function }
        let editor;
        let activeScriptId = null;

        let projectData = { assets: [], sceneObjects: [] };
        let fileSystem = []; 
        let selectedAsset = null;
        let creatingType = null;

        const SPAWNER_SCRIPT = `
// 1. Executa na inicializa√ß√£o (Editor e Play)
if (!this.initialized) {
    this.initialized = true;
    console.log("Inicializando objetos do script...");

    // Cria cubo
    const geo = new THREE.BoxGeometry(1, 1, 1);
    const mat = new THREE.MeshStandardMaterial({ color: 0x00f3ff, roughness: 0.2 });
    this.cube = new THREE.Mesh(geo, mat);
    
    // Borda Neon
    const edges = new THREE.EdgesGeometry(geo);
    this.cube.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff })));
    
    scene.add(this.cube);

    // Luz
    const light = new THREE.DirectionalLight(0xffffff, 2);
    light.position.set(2, 5, 2);
    scene.add(light);
}

// 2. Executa APENAS no Play Mode (Anima√ß√£o)
if (this.cube && isPlaying) {
    this.cube.rotation.x += delta;
    this.cube.rotation.y += delta * 0.5;
}
`;

        init();
        initEditor();
        loadProject();
        animate();

        function init() {
            const vp = document.getElementById('viewport');
            clock = new THREE.Clock();

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // EXPOR GLOBAIS
            window.scene = scene;
            window.THREE = THREE;
            window.isPlaying = false; // Scripts podem ler essa vari√°vel

            const aspect = vp.clientWidth / vp.clientHeight;
            camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 1000);
            camera.position.set(0, 0, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(vp.clientWidth, vp.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            vp.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            vp.addEventListener('mousedown', (e) => {
                if (isPlaying) return;
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children);
                if (intersects.length > 0) selectObject(intersects[0].object);
                else deselectObject();
            });

            window.addEventListener('resize', onWindowResize);
            log("Zeta Engine Pronta.", "info");
        }

        function initEditor() {
            editor = ace.edit("ace-editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/javascript");
        }

        // --- SISTEMA CENTRAL ---

        window.loadProject = function(isReload = false) {
            // Limpa cena (exceto coisas nativas se houver, mas aqui limpamos tudo)
            while(scene.children.length > 0){ scene.remove(scene.children[0]); }
            activeScripts = [];

            if(!isReload) {
                try {
                    const data = localStorage.getItem('zetaProjectData');
                    if (data) {
                        projectData = JSON.parse(data);
                        fileSystem = projectData.assets || [];
                    } else {
                        // PADR√ÉO
                        fileSystem = [{ id: 1, name: "Assets", type: "folder", children: [
                            { id: 2, name: "StartScene.js", type: "js", content: SPAWNER_SCRIPT }
                        ]}];
                        projectData.sceneObjects = [{ name: 'System_StartScene', attachedScriptId: 2, isManager: true }];
                    }
                } catch (e) { localStorage.removeItem('zetaProjectData'); }
            }

            // 1. Recria os Managers e EXECUTAR OS SCRIPTS IMEDIATAMENTE (Modo Editor)
            projectData.sceneObjects.forEach(d => {
                if(d.isManager) {
                    // Esfera amarela visual para o editor
                    const geo = new THREE.SphereGeometry(0.2);
                    const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true });
                    const manager = new THREE.Mesh(geo, mat);
                    manager.name = d.name;
                    manager.userData.isManager = true;
                    manager.userData.attachedScriptId = d.attachedScriptId;
                    scene.add(manager);

                    // EXECUTA O SCRIPT AGORA (Para criar os objetos na cena)
                    compileAndRunScript(d.attachedScriptId, manager);
                }
            });

            renderTree();
        }

        function compileAndRunScript(scriptId, managerObj) {
            const script = findItemById(fileSystem, scriptId);
            if (script && script.content) {
                try {
                    const func = new Function('time', 'delta', script.content);
                    const scriptScope = { initialized: false }; // Escopo persistente
                    
                    // Adiciona √† lista de updates
                    activeScripts.push({ scope: scriptScope, func: func, manager: managerObj });
                    
                    // Executa UMA VEZ para inicializar (criar meshes)
                    func.call(scriptScope, 0, 0);
                    
                } catch (e) { log("Erro Script: " + e.message, "warn"); }
            }
        }

        window.startPlay = function() {
            if(isPlaying) return;
            window.isPlaying = true; // Scripts usam isso para saber se devem animar

            // Esconde os √≠cones amarelos dos managers
            scene.children.forEach(c => { if(c.userData.isManager) c.visible = false; });

            document.getElementById('btn-play').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'flex';
            document.getElementById('viewport').style.border = "2px solid #00f3ff";
            deselectObject();
            log("Play Mode.", "info");
        };

        window.stopPlay = function() {
            if(!isPlaying) return;
            window.isPlaying = false;

            // Recarrega o projeto para resetar posi√ß√µes e estados dos objetos
            // Isso garante que voltamos exatamente para como estava no editor
            window.loadProject(true); 

            document.getElementById('btn-play').style.display = 'flex';
            document.getElementById('btn-stop').style.display = 'none';
            document.getElementById('viewport').style.border = "none";
            log("Editor Mode.", "warn");
        };

        // --- ASSETS & UI ---
        window.saveProject = function() {
            // Salva apenas os Managers. N√£o salvamos os cubos criados dinamicamente.
            projectData.sceneObjects = [];
            scene.children.forEach(child => {
                if (child.userData.isManager) {
                    projectData.sceneObjects.push({
                        name: child.name, attachedScriptId: child.userData.attachedScriptId, isManager: true
                    });
                }
            });
            projectData.assets = fileSystem;
            localStorage.setItem('zetaProjectData', JSON.stringify(projectData));
            log("Salvo com sucesso.", "info");
        };

        window.toggleConsole = () => document.getElementById('console-panel').classList.toggle('open');
        window.closeModal = () => document.getElementById('modal-options').style.display = 'none';
        window.resetModal = () => { document.getElementById('input-area').style.display='none'; document.getElementById('default-actions').style.display='flex'; };

        function renderTree() {
            const container = document.getElementById('asset-tree');
            container.innerHTML = '';
            
            function build(items, parent) {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'tree-node';
                    const row = document.createElement('div');
                    row.className = 'tree-item';
                    
                    const arrow = document.createElement('span');
                    arrow.className = 'arrow';
                    if(item.type === 'folder') arrow.innerText = '‚ñ∂';
                    else { arrow.innerText = '‚ñ∂'; arrow.classList.add('hidden'); }

                    const contentSpan = document.createElement('span');
                    contentSpan.innerHTML = `<span class="icon ${item.type==='folder'?'folder-icon':'js-icon'}">${item.type==='folder'?'üìÅ':'üìú'}</span> <span>${item.name}</span>`;
                    
                    row.appendChild(arrow); row.appendChild(contentSpan);
                    
                    let childrenDiv = null;
                    if(item.type === 'folder') {
                        childrenDiv = document.createElement('div');
                        childrenDiv.className = 'tree-children';
                        build(item.children, childrenDiv);
                        arrow.onclick = (e) => { e.stopPropagation(); arrow.classList.toggle('open'); childrenDiv.style.display = childrenDiv.style.display==='block'?'none':'block'; };
                    }
                    contentSpan.onclick = (e) => { e.stopPropagation(); openModalOption(item); };
                    
                    div.appendChild(row); if(childrenDiv) div.appendChild(childrenDiv); parent.appendChild(div);
                });
            }
            build(fileSystem, container);
        }

        function openModalOption(item) {
            selectedAsset = item;
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-options').style.display = 'flex';
            document.getElementById('ctx-folder').style.display = item.type==='folder'?'block':'none';
            document.getElementById('ctx-script').style.display = item.type==='js'?'block':'none';
            document.getElementById('input-area').style.display='none';
            document.getElementById('default-actions').style.display='flex';
        }

        window.showInput = (type) => {
            creatingType = type;
            document.getElementById('ctx-folder').style.display = 'none';
            document.getElementById('ctx-script').style.display = 'none';
            document.querySelector('.delete-opt').style.display = 'none';
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('default-actions').style.display = 'none';
            document.getElementById('new-item-name').focus();
        };

        window.confirmCreation = () => {
            const name = document.getElementById('new-item-name').value.trim();
            if(!name) return;
            const finalName = creatingType === 'script' ? name + '.js' : name;
            const newItem = {
                id: Date.now(), name: finalName,
                type: creatingType === 'script' ? 'js' : 'folder',
                content: creatingType === 'script' ? '// Novo Script' : null,
                children: creatingType === 'folder' ? [] : null
            };
            if(selectedAsset.type === 'folder') selectedAsset.children.push(newItem);
            renderTree();
            window.closeModal();
            window.saveProject();
        };

        window.deleteItem = () => {
            if(confirm("Deletar?")) { deleteFromFolder(fileSystem, selectedAsset.id); renderTree(); window.closeModal(); window.saveProject(); }
        };

        window.openScriptEditor = () => {
            document.getElementById('viewport').style.display = 'none';
            document.getElementById('code-editor-container').style.display = 'flex';
            document.getElementById('current-file-name').innerText = selectedAsset.name;
            editor.setValue(selectedAsset.content, -1);
            activeScriptId = selectedAsset.id;
            window.closeModal();
        };

        window.closeScriptEditor = () => {
            if(activeScriptId) {
                const item = findItemById(fileSystem, activeScriptId);
                if(item) item.content = editor.getValue();
            }
            document.getElementById('viewport').style.display = 'block';
            document.getElementById('code-editor-container').style.display = 'none';
            onWindowResize();
            window.saveProject();
            // Recarrega para ver as mudan√ßas do c√≥digo na hora
            window.loadProject(true);
        };

        window.applyScriptToScene = () => {
            const managerName = "System_" + selectedAsset.name.replace('.js', '');
            if(scene.children.find(c => c.name === managerName)) { alert("J√° existe!"); return; }

            const geo = new THREE.SphereGeometry(0.2);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true });
            const manager = new THREE.Mesh(geo, mat);
            manager.name = managerName;
            manager.userData.isManager = true;
            manager.userData.attachedScriptId = selectedAsset.id;
            
            scene.add(manager);
            compileAndRunScript(selectedAsset.id, manager); // Roda imediatamente no editor

            log(`Aplicado: ${selectedAsset.name}`, "info");
            window.closeModal();
            window.saveProject();
        };

        // Helpers
        function findItemById(list, id) {
            for(let i of list) { if(i.id === id) return i; if(i.children) { const f = findItemById(i.children, id); if(f) return f; } } return null;
        }
        function deleteFromFolder(list, id) {
            const idx = list.findIndex(i => i.id === id); if(idx > -1) { list.splice(idx,1); return true; }
            for(let i of list) if(i.children && deleteFromFolder(i.children, id)) return true; return false;
        }
        function selectObject(obj) {
            if(obj.userData.isManager) {
                if(selectedObject3D) selectedObject3D.material.color.setHex(0xffff00);
                selectedObject3D = obj;
                selectedObject3D.material.color.setHex(0xffaa00);
            }
        }
        function deselectObject() {
            if(selectedObject3D && selectedObject3D.userData.isManager) selectedObject3D.material.color.setHex(0xffff00);
            selectedObject3D = null;
        }
        function onWindowResize() {
            const vp = document.getElementById('viewport');
            if(vp.style.display === 'none') return;
            camera.aspect = vp.clientWidth / vp.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(vp.clientWidth, vp.clientHeight);
        }
        function log(msg, type="msg") {
            const el = document.getElementById('console-log');
            const d = document.createElement('div');
            d.innerText = "> " + msg;
            d.style.color = type==='info'?'#00f3ff':(type==='warn'?'#ff0055':'#aaa');
            el.appendChild(d);
            el.scrollTop = el.scrollHeight;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const time = clock.getElapsedTime();

            // Sempre chama o script, mas o script decide se anima com base no 'isPlaying'
            activeScripts.forEach(s => {
                try { s.func.call(s.scope, time, delta); } catch(e){}
            });

            if(!isPlaying) controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
