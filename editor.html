<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zeta Engine - Physics & Camera</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap');

        /* --- CSS RESET & LAYOUT --- */
        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #050505; color: #ddd;
            font-family: 'Roboto', sans-serif; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* TOOLBAR */
        #toolbar {
            height: 50px; background: #111; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 10; flex-shrink: 0;
        }
        .toolbar-group { display: flex; gap: 10px; align-items: center; }
        .tool-btn {
            background: transparent; border: 1px solid #333; border-radius: 4px;
            width: 40px; height: 35px; cursor: pointer; color: #888;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; font-size: 1.2rem;
        }
        .tool-btn:hover { background: rgba(0, 243, 255, 0.1); color: #00f3ff; border-color: #00f3ff; }
        .btn-play { color: #00f3ff; border-color: #00f3ff; }
        .btn-stop { color: #ff0055; border-color: #ff0055; display: none; }
        .save-btn { font-size: 0.8rem; width: auto; padding: 0 15px; gap: 5px; font-family: 'Orbitron'; }

        /* WORKSPACE */
        #workspace { 
            flex: 1; display: flex; position: relative; overflow: hidden; 
            flex-direction: row; 
        }

        /* VIEWPORT */
        #viewport { 
            flex: 1; background-color: #1a1a1a; position: relative; overflow: hidden; 
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* EDITOR ACE */
        #code-editor-container {
            flex: 1; display: none; flex-direction: column;
            background: #141414; position: relative; z-index: 30; height: 100%;
        }
        #ace-editor { flex: 1; font-size: 16px; }
        .editor-bar {
            height: 40px; background: #1a1a1a; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 10px; flex-shrink: 0;
        }

        /* PAINEL DIREITO */
        #right-panel {
            width: 150px; background: #0f0f12; border-left: 1px solid #333;
            display: flex; flex-direction: column; z-index: 20; flex-shrink: 0;
        }
        .panel-tabs {
            display: flex; height: 40px; background: #151515; border-bottom: 1px solid #333;
        }
        .tab-btn {
            flex: 1; border: none; background: transparent; color: #555; cursor: pointer;
            font-size: 1.2rem; border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: #00f3ff; border-bottom: 2px solid #00f3ff; background: rgba(0,243,255,0.05); }
        .panel-content { 
            flex: 1; overflow-y: auto; overflow-x: hidden; padding: 5px;
            font-family: 'Fira Code', monospace; font-size: 0.75rem; 
        }

        /* ARVORE */
        .tree-node { margin-bottom: 2px; }
        .tree-item {
            display: flex; align-items: center; padding: 6px 2px;
            cursor: pointer; color: #aaa; transition: 0.2s;
            border-radius: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .tree-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tree-item.selected { background: rgba(0, 243, 255, 0.2); color: #00f3ff; border: 1px solid rgba(0,243,255,0.3); }
        .arrow { width: 15px; text-align: center; font-size: 8px; cursor: pointer; color: #666; }
        .arrow.open { transform: rotate(90deg); color: #00f3ff; }
        .icon { margin-right: 4px; font-size: 0.9rem; }
        .folder-icon { color: #dcb67a; } .js-icon { color: #f7df1e; } .obj-icon { color: #00f3ff; }
        .tree-children { display: none; border-left: 1px solid #333; margin-left: 6px; padding-left: 2px; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .asset-modal {
            background: #111; border: 1px solid #00f3ff; width: 300px;
            padding: 20px; border-radius: 8px; box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
        }
        .modal-option {
            background: #1a1a1a; color: #ddd; padding: 12px; margin-bottom: 8px;
            border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .modal-input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; margin-bottom: 10px; }
        .btn-action { background: #00f3ff; color: #000; border: none; padding: 6px 12px; cursor: pointer; font-weight: bold; }

        /* CONSOLE & INDICATOR */
        #console-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0, 0, 0, 0.95); border-top: 1px solid #00f3ff;
            transform: translateY(100%); transition: transform 0.3s ease;
            z-index: 5; display: flex; flex-direction: column;
        }
        #console-panel.open { transform: translateY(0); }
        .console-body { padding: 10px; font-family: 'Fira Code', monospace; font-size: 0.8rem; color: #aaa; overflow-y: auto; flex: 1; }
        
        #cam-indicator {
            position: absolute; top: 10px; right: 10px; 
            padding: 5px 10px; background: rgba(0,0,0,0.5); 
            color: #fff; font-size: 0.7rem; border-radius: 4px; pointer-events: none;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.171.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.171.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>

    <div id="toolbar">
        <div class="toolbar-group">
            <button class="tool-btn" onclick="window.location.href='menu.html'">‚¨Ö</button>
            <button class="tool-btn save-btn" onclick="saveProject()">üíæ</button>
        </div>
        <div class="toolbar-group">
            <button id="btn-play" class="tool-btn btn-play" onclick="startPlay()">‚ñ∂</button>
            <button id="btn-stop" class="tool-btn btn-stop" onclick="stopPlay()">‚èπ</button>
        </div>
        <div class="toolbar-group">
            <button class="tool-btn" onclick="toggleConsole()">üíª</button>
        </div>
    </div>

    <div id="workspace">
        <div id="code-editor-container">
            <div class="editor-bar">
                <div style="color:#f7df1e; font-family:'Fira Code'; font-size:0.8rem;">üìú <span id="current-file-name">script.js</span></div>
                <button class="btn-action" onclick="closeScriptEditor()">SALVAR</button>
            </div>
            <div id="ace-editor"></div>
        </div>

        <div id="viewport">
            <div id="cam-indicator">üé• EDITOR CAM</div>
            <div id="console-panel">
                <div style="padding:5px 10px; background:#111; color:#00f3ff; display:flex; justify-content:space-between;">
                    <span>LOG</span><span style="cursor:pointer" onclick="toggleConsole()">‚ñº</span>
                </div>
                <div class="console-body" id="console-log"></div>
            </div>
        </div>

        <div id="right-panel">
            <div class="panel-tabs">
                <button id="tab-assets" class="tab-btn active" onclick="switchTab('assets')">üìÅ</button>
                <button id="tab-hierarchy" class="tab-btn" onclick="switchTab('hierarchy')">üå≥</button>
            </div>
            <div class="panel-content" id="panel-list"></div>
        </div>
    </div>

    <div id="modal-options" class="modal-overlay">
        <div class="asset-modal">
            <h3 id="modal-title">Op√ß√µes</h3>
            <div id="ctx-folder">
                <div class="modal-option" onclick="showInput('folder')">üìÅ Nova Pasta</div>
                <div class="modal-option" onclick="showInput('script')">üìú Novo Script JS</div>
            </div>
            <div id="ctx-script" style="display:none;">
                <div class="modal-option" onclick="openScriptEditor()">‚úèÔ∏è Editar C√≥digo</div>
                <div class="modal-option" onclick="applyScriptToScene()">‚ö° Aplicar Global</div>
            </div>
            <div class="modal-option" style="color:#ff0055; border-color:#ff0055" onclick="deleteItem()">üóëÔ∏è Deletar</div>
            
            <div id="input-area" style="display:none;">
                <input type="text" id="new-item-name" class="modal-input" placeholder="Nome...">
                <div style="display:flex; justify-content:end; gap:10px;">
                    <button class="btn-action" style="background:#333; color:#fff" onclick="resetModal()">Cancelar</button>
                    <button class="btn-action" onclick="confirmCreation()">CRIAR</button>
                </div>
            </div>
            <div style="display:flex; justify-content:end; margin-top:15px;" id="default-actions">
                <button class="btn-action" style="background:#333; color:#fff" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'cannon-es';

        // GLOBAIS DE ENGINE
        let editorCamera, gameCamera = null;
        let scene, renderer, controls, clock;
        let physicsWorld;
        let physicsMap = new Map(); // Mapa visual (Mesh) -> fisico (Body)

        let selectedObject3D = null;
        let isPlaying = false;
        let activeScripts = []; 
        let editor;
        let activeScriptId = null;
        let projectData = { assets: [], sceneObjects: [] };
        let fileSystem = []; 
        let selectedAsset = null;
        let creatingType = null;
        let currentTab = 'assets';

        // --- SCRIPTS PADR√ÉO (ATUALIZADOS PARA F√çSICA) ---
        const DEFAULT_SCRIPT = `if (!this.init) { this.init=true; console.log("Start"); }`;
        
        const CUBE_SCRIPT = `
// CUBO COM F√çSICA DIN√ÇMICA
if (!this.mesh) {
    // 1. Visual
    const geo = new THREE.BoxGeometry(1,1,1);
    const mat = new THREE.MeshStandardMaterial({color:0x00f3ff});
    this.mesh = new THREE.Mesh(geo, mat);
    const id = Math.random().toString(36).substr(2, 4);
    this.mesh.name = "Cube_" + id; 
    // Posiciona no alto para cair
    this.mesh.position.set(0, 5, 0); 
    scene.add(this.mesh);

    // 2. F√≠sica (S√≥ executa se estiver em Play Mode)
    // Usamos o helper window.addPhysics para integrar
    if (isPlaying) {
        const shape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5)); // Metade do tamanho
        const body = new CANNON.Body({
            mass: 1, // Massa > 0 = Din√¢mico (cai)
            shape: shape
        });
        body.position.copy(this.mesh.position);
        
        // Adiciona √† simula√ß√£o
        window.addPhysics(this.mesh, body);
        console.log("F√≠sica adicionada ao cubo");
    }
}`;

        const FLOOR_SCRIPT = `
// CH√ÉO EST√ÅTICO
if (!this.mesh) {
    const geo = new THREE.PlaneGeometry(10, 10);
    const mat = new THREE.MeshStandardMaterial({color:0x222222});
    this.mesh = new THREE.Mesh(geo, mat);
    this.mesh.rotation.x = -Math.PI / 2;
    this.mesh.name = "Chao";
    scene.add(this.mesh);
    
    // Grade visual para ajudar
    const grid = new THREE.GridHelper(10, 10);
    scene.add(grid);

    if (isPlaying) {
        const shape = new CANNON.Plane();
        const body = new CANNON.Body({
            mass: 0, // Massa 0 = Est√°tico (n√£o mexe)
            shape: shape
        });
        body.quaternion.copy(this.mesh.quaternion);
        window.addPhysics(this.mesh, body);
    }
}`;

        const SUNLIGHT_SCRIPT = `
if (!this.light) {
    this.light = new THREE.DirectionalLight(0xffffff, 2);
    this.light.position.set(5,10,5);
    this.light.name = "Sol";
    scene.add(this.light);
}`;

        const CAMERA_SCRIPT = `
// C√ÇMERA DE JOGO (Perspective)
if (!this.cam) {
    this.cam = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    this.cam.position.set(0, 3, 8);
    this.cam.lookAt(0, 1, 0);
    this.cam.name = "GameCam";
    scene.add(this.cam);
    
    // Define camera global
    window.gameCamera = this.cam;
}
`;

        init();
        initEditor();
        loadProject(); 
        animate();

        function init() {
            const vp = document.getElementById('viewport');
            clock = new THREE.Clock();
            
            // THREE JS
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // CANNON JS
            physicsWorld = new CANNON.World();
            physicsWorld.gravity.set(0, -9.82, 0);
            
            // EXPOR PARA SCRIPTS
            window.scene = scene; 
            window.THREE = THREE;
            window.CANNON = CANNON;
            window.physicsWorld = physicsWorld;

            // HELPER: Adiciona f√≠sica e liga visual ao corpo
            window.addPhysics = (mesh, body) => {
                physicsWorld.addBody(body);
                physicsMap.set(mesh, body);
            };

            // EDITOR CAMERA
            editorCamera = new THREE.PerspectiveCamera(60, vp.clientWidth / vp.clientHeight, 0.1, 1000);
            editorCamera.position.set(5, 5, 8);
            editorCamera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(vp.clientWidth, vp.clientHeight);
            vp.appendChild(renderer.domElement);

            controls = new OrbitControls(editorCamera, renderer.domElement);
            controls.enableDamping = true;

            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            vp.addEventListener('mousedown', (e) => {
                if (isPlaying) return; 
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, editorCamera);
                const intersects = raycaster.intersectObjects(scene.children);
                
                if (intersects.length > 0) selectObject(intersects[0].object);
                else deselectObject();
            });

            window.addEventListener('resize', onWindowResize);
        }

        function initEditor() {
            editor = ace.edit("ace-editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/javascript");
            
            window.addEventListener("resize", () => {
                editor.resize();
                editor.renderer.scrollCursorIntoView();
            });
            editor.setOption("autoScrollEditorIntoView", true);
        }

        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tab-assets').classList.toggle('active', tab === 'assets');
            document.getElementById('tab-hierarchy').classList.toggle('active', tab === 'hierarchy');
            renderRightPanel();
        }

        function renderRightPanel() {
            const container = document.getElementById('panel-list');
            container.innerHTML = '';
            if (currentTab === 'assets') renderAssetTree(fileSystem, container);
            else renderHierarchyTree(scene.children, container);
        }

        function renderAssetTree(items, parent) {
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'tree-node';
                const row = document.createElement('div');
                row.className = 'tree-item';
                
                const arrow = document.createElement('span');
                arrow.className = 'arrow';
                if(item.type === 'folder') arrow.innerText = '‚ñ∂';
                
                const label = document.createElement('span');
                label.innerHTML = `<span class="icon ${item.type==='folder'?'folder-icon':'js-icon'}">${item.type==='folder'?'üìÅ':'üìú'}</span> ${item.name}`;
                
                row.appendChild(arrow); row.appendChild(label);
                
                let childrenDiv = null;
                if(item.type === 'folder') {
                    childrenDiv = document.createElement('div');
                    childrenDiv.className = 'tree-children';
                    renderAssetTree(item.children, childrenDiv);
                    arrow.onclick = (e) => { e.stopPropagation(); arrow.classList.toggle('open'); childrenDiv.style.display = childrenDiv.style.display==='block'?'none':'block'; };
                }
                label.onclick = (e) => { e.stopPropagation(); openModalOption(item); };
                
                div.appendChild(row); if(childrenDiv) div.appendChild(childrenDiv); parent.appendChild(div);
            });
        }

        function renderHierarchyTree(objects, parent) {
            objects.forEach(obj => {
                if (obj.type === "GridHelper") return;
                if (obj.userData.isManager) return; // Esconde gerenciadores invisiveis

                const div = document.createElement('div');
                div.className = 'tree-node';
                const row = document.createElement('div');
                row.className = 'tree-item';
                if(selectedObject3D === obj) row.classList.add('selected');

                const label = document.createElement('span');
                let icon = 'üì¶';
                if(obj.isLight) icon = 'üí°';
                if(obj.isCamera) icon = 'üé•';
                
                label.innerHTML = `<span class="icon obj-icon">${icon}</span> ${obj.name || obj.type}`;
                
                row.appendChild(label);
                row.onclick = () => selectObject(obj);
                div.appendChild(row);
                parent.appendChild(div);

                if(obj.children.length > 0) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'tree-children';
                    childrenDiv.style.display = 'block'; 
                    renderHierarchyTree(obj.children, childrenDiv);
                    div.appendChild(childrenDiv);
                }
            });
        }

        window.openScriptEditor = () => {
            document.getElementById('viewport').style.display = 'none';
            document.getElementById('right-panel').style.display = 'none';
            document.getElementById('code-editor-container').style.display = 'flex';
            document.getElementById('current-file-name').innerText = selectedAsset.name;
            editor.setValue(selectedAsset.content, -1);
            activeScriptId = selectedAsset.id;
            window.closeModal();
        };

        window.closeScriptEditor = () => {
            if(activeScriptId) {
                const item = findItemById(fileSystem, activeScriptId);
                if(item) item.content = editor.getValue();
            }
            document.getElementById('viewport').style.display = 'block';
            document.getElementById('right-panel').style.display = 'flex';
            document.getElementById('code-editor-container').style.display = 'none';
            window.saveProject();
        };

        window.openModalOption = (item) => {
            selectedAsset = item;
            document.getElementById('modal-title').innerText = item.name;
            document.getElementById('modal-options').style.display = 'flex';
            document.getElementById('ctx-folder').style.display = item.type==='folder'?'block':'none';
            document.getElementById('ctx-script').style.display = item.type==='js'?'block':'none';
            document.getElementById('input-area').style.display='none';
            document.getElementById('default-actions').style.display='flex';
        };

        window.showInput = (type) => {
            creatingType = type;
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('default-actions').style.display = 'none';
            document.getElementById('ctx-folder').style.display='none';
            document.getElementById('ctx-script').style.display='none';
            document.getElementById('new-item-name').focus();
        };

        window.confirmCreation = () => {
            const name = document.getElementById('new-item-name').value.trim();
            if(!name) return;
            const finalName = creatingType === 'script' ? name + '.js' : name;
            const newItem = {
                id: Date.now(), name: finalName,
                type: creatingType === 'script' ? 'js' : 'folder',
                content: creatingType === 'script' ? DEFAULT_SCRIPT : null,
                children: creatingType === 'folder' ? [] : null
            };
            if(selectedAsset.type === 'folder') selectedAsset.children.push(newItem);
            renderRightPanel();
            window.closeModal();
            window.saveProject();
        };

        window.deleteItem = () => {
             if(confirm("Apagar?")) { deleteFromFolder(fileSystem, selectedAsset.id); renderRightPanel(); window.closeModal(); window.saveProject(); }
        }

        window.applyScriptToScene = () => {
            const randId = Math.floor(Math.random() * 999);
            const managerName = "Sys_" + selectedAsset.name.replace('.js', '') + "_" + randId;
            const manager = createManager(managerName, selectedAsset.id);
            scene.add(manager);
            compileAndRegisterScript(selectedAsset.id, selectedAsset.content);
            renderRightPanel();
            window.closeModal();
            window.saveProject();
        };

        window.saveProject = () => {
            projectData.sceneObjects = [];
            scene.children.forEach(child => {
                if (child.userData.isManager) {
                    projectData.sceneObjects.push({
                        name: child.name, attachedScriptId: child.userData.attachedScriptId,
                        isManager: true, position: child.position.toArray()
                    });
                }
            });
            projectData.assets = fileSystem;
            localStorage.setItem('zetaProjectData', JSON.stringify(projectData));
            log("Salvo.", "info");
        };

        window.startPlay = () => { 
            if(isPlaying)return; 
            isPlaying=true; 
            
            // Re-executa scripts para ativar f√≠sica
            // Primeiro limpamos o mundo f√≠sico de sujeira anterior
            physicsWorld.bodies = []; 
            physicsMap.clear();

            scene.children.forEach(c => { if(c.userData.isManager) c.visible=false; });
            
            // Recarrega cena para executar l√≥gica "if (isPlaying)" dos scripts
            // Isso garante que a f√≠sica seja criada DO ZERO
            while(scene.children.length>0) scene.remove(scene.children[0]);
            loadProject(true);

            document.getElementById('btn-play').style.display='none'; 
            document.getElementById('btn-stop').style.display='flex';
            document.getElementById('viewport').style.border="2px solid #00f3ff";
            
            deselectObject();
        };
        
        window.stopPlay = () => { 
            if(!isPlaying)return; 
            isPlaying=false; 
            gameCamera = null; window.gameCamera = null;
            
            // Limpa f√≠sica
            physicsWorld.bodies = [];
            physicsMap.clear();

            while(scene.children.length>0) scene.remove(scene.children[0]);
            loadProject(true);
            
            document.getElementById('btn-play').style.display='flex'; 
            document.getElementById('btn-stop').style.display='none';
            document.getElementById('viewport').style.border="none";
        };

        function createManager(name, scriptId) {
            const geo = new THREE.SphereGeometry(0.2);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true });
            const manager = new THREE.Mesh(geo, mat);
            manager.name = name;
            manager.userData.isManager = true;
            manager.userData.attachedScriptId = scriptId;
            return manager;
        }

        function compileAndRegisterScript(id, content) {
            try {
                const func = new Function('time', 'delta', 'isPlaying', content);
                const scope = { mesh: null, cam: null, light: null, init: false }; 
                func.call(scope, 0, 0, isPlaying); // Passa isPlaying corretamente
                activeScripts.push({ id, func, scope });
            } catch (e) { log("Erro JS: " + e.message, "warn"); }
        }

        function loadProject(isReload = false) {
            if(!isReload) {
                try {
                    const data = localStorage.getItem('zetaProjectData');
                    if (data) { projectData = JSON.parse(data); fileSystem = projectData.assets || []; } 
                    else {
                        // --- PROJETO COM ASSETS F√çSICA + C√ÇMERA ---
                        fileSystem = [{ id: 1, name: "Assets", type: "folder", children: [
                            { id: 10, name: "cube.js", type: "js", content: CUBE_SCRIPT },
                            { id: 11, name: "floor.js", type: "js", content: FLOOR_SCRIPT },
                            { id: 12, name: "sun.js", type: "js", content: SUNLIGHT_SCRIPT },
                            { id: 13, name: "perspective.js", type: "js", content: CAMERA_SCRIPT }
                        ]}];
                        projectData.sceneObjects = [
                            { name: 'Sys_Floor', attachedScriptId: 11, isManager: true, position: [0,0,0] },
                            { name: 'Sys_Cube', attachedScriptId: 10, isManager: true, position: [0,0,0] },
                            { name: 'Sys_Sun', attachedScriptId: 12, isManager: true, position: [0,0,0] },
                            { name: 'Sys_Cam', attachedScriptId: 13, isManager: true, position: [0,0,0] }
                        ];
                    }
                } catch (e) { localStorage.removeItem('zetaProjectData'); }
            }
            if(!scene.children.find(c => c instanceof THREE.GridHelper) && !isPlaying) {
                 // Grid s√≥ no editor, no play mode o floor script cuida disso
                 scene.add(new THREE.GridHelper(20, 20, 0x333333, 0x222222));
            }
            activeScripts = []; 
            projectData.sceneObjects.forEach(d => {
                const manager = createManager(d.name, d.attachedScriptId);
                if(d.position) manager.position.fromArray(d.position);
                scene.add(manager);
                const scriptItem = findItemById(fileSystem, d.attachedScriptId);
                if(scriptItem) compileAndRegisterScript(scriptItem.id, scriptItem.content);
            });
            renderRightPanel();
        }

        function findItemById(l, id) { for(let i of l){ if(i.id===id)return i; if(i.children){const f=findItemById(i.children,id);if(f)return f;}} return null;}
        function deleteFromFolder(l, id) { const idx=l.findIndex(i=>i.id===id); if(idx>-1){l.splice(idx,1);return true;} for(let i of l) if(i.children && deleteFromFolder(i.children,id)) return true; return false;}
        
        function selectObject(obj) {
            if(selectedObject3D && selectedObject3D.material && selectedObject3D.material.emissive) selectedObject3D.material.emissive.setHex(0x000000);
            selectedObject3D = obj;
            if(obj.userData.isManager) obj.material.color.setHex(0xffaa00);
            else if(obj.material && obj.material.emissive) obj.material.emissive.setHex(0x333333);
            if(currentTab === 'hierarchy') renderRightPanel();
        }
        function deselectObject() {
            if(selectedObject3D && selectedObject3D.userData.isManager) selectedObject3D.material.color.setHex(0xffff00);
            else if(selectedObject3D && selectedObject3D.material && selectedObject3D.material.emissive) selectedObject3D.material.emissive.setHex(0x000000);
            selectedObject3D = null;
            if(currentTab === 'hierarchy') renderRightPanel();
        }
        function onWindowResize() {
            const vp = document.getElementById('viewport');
            if(vp.style.display==='none')return;
            const aspect = vp.clientWidth / vp.clientHeight;
            editorCamera.aspect = aspect; editorCamera.updateProjectionMatrix();
            if (window.gameCamera) { window.gameCamera.aspect = aspect; window.gameCamera.updateProjectionMatrix(); }
            renderer.setSize(vp.clientWidth, vp.clientHeight);
        }
        function log(msg, t) { const e=document.getElementById('console-log'); const d=document.createElement('div'); d.innerText="> "+msg; d.style.color=t==='warn'?'#ff0055':'#00f3ff'; e.appendChild(d); e.scrollTop=e.scrollHeight; }
        window.toggleConsole = () => document.getElementById('console-panel').classList.toggle('open');
        window.closeModal = () => document.getElementById('modal-options').style.display='none';
        window.resetModal = () => { document.getElementById('input-area').style.display='none'; document.getElementById('default-actions').style.display='flex'; };

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const time = clock.getElapsedTime();
            
            // L√≥gica de Scripts
            activeScripts.forEach(s => { try{s.func.call(s.scope, time, delta, isPlaying)}catch(e){} });
            
            // F√çSICA LOOP
            if(isPlaying) {
                // Passo fixo de 1/60s para estabilidade
                physicsWorld.step(1/60, delta, 3);

                // Sincroniza Visual <- F√≠sico
                physicsMap.forEach((body, mesh) => {
                    mesh.position.copy(body.position);
                    mesh.quaternion.copy(body.quaternion);
                });

                if(window.gameCamera) {
                    gameCamera = window.gameCamera;
                    document.getElementById('cam-indicator').innerText = "üé• GAME CAM (PHYSICS ON)";
                    document.getElementById('cam-indicator').style.color = "#00f3ff";
                }
            } else {
                gameCamera = null;
                document.getElementById('cam-indicator').innerText = "üé• EDITOR CAM";
                document.getElementById('cam-indicator').style.color = "#ffffff";
                controls.update();
            }

            const activeCam = (isPlaying && gameCamera) ? gameCamera : editorCamera;
            renderer.render(scene, activeCam);
        }
    </script>
</body>
</html>
